name: Project Review and Quality Check

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Cháº¡y tá»± Ä‘á»™ng hÃ ng tuáº§n vÃ o thá»© 2 lÃºc 9:00 AM
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Cho phÃ©p cháº¡y thá»§ cÃ´ng

jobs:
  check-completion:
    name: Kiá»ƒm tra Tá»· lá»‡ HoÃ n thiá»‡n
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Run completion check
      id: completion
      run: |
        python scripts/calculate_completion.py || echo "completion_status=$?" >> $GITHUB_OUTPUT
        
    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸ” **Kiá»ƒm tra tá»· lá»‡ hoÃ n thiá»‡n dá»± Ã¡n Ä‘Ã£ Ä‘Æ°á»£c thá»±c hiá»‡n**\n\nXem chi tiáº¿t trong workflow logs.'
          })

  cross-reference:
    name: Äá»‘i chiáº¿u LÃ½ thuyáº¿t vÃ  Thá»±c táº¿
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Run cross-reference analysis
      run: |
        python scripts/cross_reference.py
        
    - name: Upload report
      uses: actions/upload-artifact@v3
      with:
        name: cross-reference-report
        path: docs/reports/cross_reference_report.json
        
  code-quality:
    name: Kiá»ƒm tra Cháº¥t lÆ°á»£ng Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Check for common issues
      run: |
        echo "ðŸ” Checking for common code quality issues..."
        
        # Check for TODO/FIXME comments
        echo "ðŸ“ Checking for TODO/FIXME comments..."
        if grep -r "TODO\|FIXME" --exclude-dir=".git" --exclude-dir="node_modules" . ; then
          echo "âš ï¸ Found TODO/FIXME comments that should be addressed"
        fi
        
        # Check for hardcoded secrets patterns
        echo "ðŸ” Checking for potential hardcoded secrets..."
        if grep -rE "(password|secret|api_key|token)\s*=\s*['\"][^'\"]+['\"]" --exclude-dir=".git" --exclude-dir="node_modules" . ; then
          echo "âš ï¸ Found potential hardcoded secrets - please review"
        fi
        
    - name: File structure check
      run: |
        echo "ðŸ“ Checking file structure..."
        ls -la
        
        # Check for essential files
        if [ ! -f "README.md" ]; then
          echo "âŒ README.md is missing"
          exit 1
        fi
        echo "âœ… README.md exists"
        
  security-check:
    name: Kiá»ƒm tra Báº£o máº­t
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check for sensitive files
      run: |
        echo "ðŸ” Checking for sensitive files..."
        
        # Check if .env files are committed (should not be)
        if find . -name ".env" -not -path "*/node_modules/*" -not -path "*/.git/*" | grep -q .; then
          echo "âš ï¸ Found .env files - these should not be committed"
        fi
        
        # Check for .env.example
        if [ ! -f ".env.example" ]; then
          echo "ðŸ’¡ Consider adding .env.example for documentation"
        fi
        
    - name: Check gitignore
      run: |
        echo "ðŸ“ Checking .gitignore..."
        if [ ! -f ".gitignore" ]; then
          echo "âš ï¸ .gitignore is missing"
        else
          echo "âœ… .gitignore exists"
        fi

  documentation-check:
    name: Kiá»ƒm tra TÃ i liá»‡u
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check documentation completeness
      run: |
        echo "ðŸ“š Checking documentation..."
        
        # Count markdown files
        md_count=$(find . -name "*.md" -not -path "*/node_modules/*" -not -path "*/.git/*" | wc -l)
        echo "Found $md_count markdown files"
        
        # Check for key documentation files
        if [ -f "docs/theory/THEORY.md" ]; then
          echo "âœ… Theory documentation exists"
        else
          echo "âŒ Theory documentation missing"
        fi
        
        if [ -f "docs/checklists/CHECKLIST.md" ]; then
          echo "âœ… Checklist exists"
        else
          echo "âŒ Checklist missing"
        fi
        
        if [ -f "docs/checklists/STANDARDS.md" ]; then
          echo "âœ… Standards documentation exists"
        else
          echo "âŒ Standards documentation missing"
        fi

  generate-report:
    name: Táº¡o BÃ¡o cÃ¡o Tá»•ng há»£p
    needs: [check-completion, cross-reference, code-quality, security-check, documentation-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Generate summary report
      run: |
        echo "# ðŸ“Š BÃ¡o cÃ¡o Tá»•ng há»£p ÄÃ¡nh giÃ¡ Dá»± Ã¡n" > report.md
        echo "" >> report.md
        echo "**NgÃ y:** $(date '+%Y-%m-%d %H:%M:%S')" >> report.md
        echo "**Branch:** ${{ github.ref_name }}" >> report.md
        echo "**Commit:** ${{ github.sha }}" >> report.md
        echo "" >> report.md
        echo "## Káº¿t quáº£ cÃ¡c kiá»ƒm tra:" >> report.md
        echo "" >> report.md
        echo "- âœ… Kiá»ƒm tra hoÃ n thiá»‡n: ${{ needs.check-completion.result }}" >> report.md
        echo "- âœ… Äá»‘i chiáº¿u lÃ½ thuyáº¿t: ${{ needs.cross-reference.result }}" >> report.md
        echo "- âœ… Cháº¥t lÆ°á»£ng code: ${{ needs.code-quality.result }}" >> report.md
        echo "- âœ… Báº£o máº­t: ${{ needs.security-check.result }}" >> report.md
        echo "- âœ… TÃ i liá»‡u: ${{ needs.documentation-check.result }}" >> report.md
        echo "" >> report.md
        echo "Xem chi tiáº¿t trong workflow logs." >> report.md
        
        cat report.md
        
    - name: Upload report
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: report.md
